<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Estado y Actualización de Firmware</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Estado de Dispositivos</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">MAC</th>
            <th class="p-2">Nombre</th>
            <th class="p-2">Estado</th>
            <th class="p-2">Versión</th>
            <th class="p-2">Último Visto</th>
            <th class="p-2">Salud</th>
          </tr>
        </thead>
        <tbody>
          <% for (let mac in devices) { %>
            <tr class="border-b">
              <td class="p-2"><%= mac %></td>
              <td class="p-2"><%= devices[mac].name %></td>
              <td class="p-2 <%= devices[mac].status === 'online' ? 'text-green-600' : 'text-red-600' %>">
                <%= devices[mac].status %>
              </td>
              <td class="p-2"><%= devices[mac].version %></td>
              <td class="p-2"><%= devices[mac].lastSeen ? new Date(devices[mac].lastSeen).toLocaleString('es-AR') : '' %></td>
              <td class="p-2"><%= devices[mac].health %></td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Actualizar Firmware</h2>
        <form id="firmwareForm" enctype="multipart/form-data">
          <label for="deviceId" class="block font-semibold">Selecciona el dispositivo:</label>
          <select name="deviceId" id="deviceId" class="w-full p-2 border rounded">
            <option value="all">Todos</option>
            <% Object.keys(devices).forEach(function(mac) { %>
              <option value="<%= mac %>"><%= mac %> - <%= devices[mac].name %></option>
            <% }); %>
          </select>
          <label for="firmware" class="block font-semibold mt-4">Selecciona el firmware (.bin):</label>
          <input type="file" name="firmware" id="firmware" accept=".bin" required class="w-full p-2 border rounded">
          <button type="submit" class="mt-4 w-full p-2 bg-blue-500 text-white rounded">Actualizar Firmware</button>
        </form>
      </div>
      
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Logs de Depuración</h2>
        <div id="logs" class="h-40 overflow-auto bg-black text-green-400 p-2 rounded">
          <% logs.forEach(function(log) { %>
            <p><%= log %></p>
          <% }) %>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const logsDiv = document.getElementById('logs');
    socket.on('log', function(message) {
      const p = document.createElement('p');
      p.textContent = message;
      logsDiv.appendChild(p);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    });
  </script>
</body>
</html>
